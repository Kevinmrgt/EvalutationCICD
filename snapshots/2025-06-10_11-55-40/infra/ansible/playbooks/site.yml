---
# Playbook principal pour le dÃ©ploiement complet de l'infrastructure CI/CD Node.js
# Ce playbook orchestre l'installation et la configuration de tous les composants

- name: "ğŸš€ CI/CD Node.js - DÃ©ploiement complet"
  hosts: localhost
  connection: local
  gather_facts: false
  vars:
    deployment_timestamp: "{{ ansible_date_time.epoch }}"
    deployment_id: "deploy-{{ deployment_timestamp }}"
  
  tasks:
    - name: "ğŸ“‹ Affichage des informations de dÃ©ploiement"
      debug:
        msg:
          - "=== DÃ©ploiement CI/CD Node.js ==="
          - "ID de dÃ©ploiement: {{ deployment_id }}"
          - "Timestamp: {{ ansible_date_time.iso8601 }}"
          - "Utilisateur: {{ ansible_user_id }}"
          - "Environnement cible: {{ target_environment | default('development') }}"

    - name: "ğŸ“¦ Validation des prÃ©requis"
      include_tasks: tasks/validate-prerequisites.yml

# Configuration des serveurs web
- name: "ğŸŒ Configuration des serveurs web"
  hosts: web_servers
  become: true
  gather_facts: true
  serial: "{{ deployment_serial | default('50%') }}"
  max_fail_percentage: 10
  
  vars:
    deployment_strategy: "{{ deployment_strategy | default('rolling') }}"
    health_check_retries: 5
    health_check_delay: 10
  
  pre_tasks:
    - name: "ğŸ” VÃ©rification de la connectivitÃ©"
      ping:
      
    - name: "ğŸ“Š Collecte des facts systÃ¨me"
      setup:
        gather_subset:
          - hardware
          - network
          - virtual
          
    - name: "ğŸ·ï¸ Application des tags de dÃ©ploiement"
      set_fact:
        server_tags:
          deployment_id: "{{ deployment_id }}"
          deployment_time: "{{ ansible_date_time.iso8601 }}"
          ansible_managed: true
          
  roles:
    - role: common
      tags: [common, base]
    - role: security
      tags: [security, hardening]
    - role: monitoring
      tags: [monitoring, observability]
    - role: nodejs
      tags: [nodejs, runtime]
    - role: application
      tags: [app, deployment]
      
  post_tasks:
    - name: "ğŸ¥ VÃ©rification de santÃ© post-dÃ©ploiement"
      include_tasks: tasks/health-check.yml
      
    - name: "ğŸ“ Enregistrement du dÃ©ploiement"
      include_tasks: tasks/record-deployment.yml

# Configuration des serveurs de base de donnÃ©es
- name: "ğŸ—„ï¸ Configuration des serveurs de base de donnÃ©es"
  hosts: database_servers
  become: true
  gather_facts: true
  serial: 1  # DÃ©ploiement sÃ©quentiel pour les bases de donnÃ©es
  
  vars:
    backup_before_update: true
    
  pre_tasks:
    - name: "ğŸ” VÃ©rification de la connectivitÃ© base de donnÃ©es"
      ping:
      
    - name: "ğŸ’¾ Sauvegarde prÃ©-dÃ©ploiement"
      include_tasks: tasks/database-backup.yml
      when: backup_before_update | bool
      
  roles:
    - role: common
      tags: [common, base]
    - role: security
      tags: [security, hardening]
    - role: database
      tags: [database, postgres]
    - role: monitoring
      tags: [monitoring, observability]
      
  post_tasks:
    - name: "ğŸ¥ VÃ©rification de santÃ© base de donnÃ©es"
      include_tasks: tasks/database-health-check.yml

# DÃ©ploiement de l'application
- name: "ğŸ“± DÃ©ploiement de l'application Node.js"
  hosts: web_servers
  become: true
  gather_facts: false
  serial: "{{ app_deployment_serial | default('25%') }}"
  
  vars:
    app_version: "{{ app_version | default('latest') }}"
    rollback_enabled: true
    zero_downtime: true
    
  pre_tasks:
    - name: "ğŸ”„ PrÃ©paration du dÃ©ploiement rolling"
      include_tasks: tasks/prepare-rolling-deployment.yml
      when: deployment_strategy == 'rolling'
      
  roles:
    - role: application-deploy
      tags: [deploy, application]
      
  post_tasks:
    - name: "ğŸ¥ Test de santÃ© application"
      include_tasks: tasks/application-health-check.yml
      
    - name: "ğŸ”„ Mise Ã  jour du load balancer"
      include_tasks: tasks/update-load-balancer.yml
      when: zero_downtime | bool

# Tests de validation
- name: "ğŸ§ª Tests de validation end-to-end"
  hosts: localhost
  connection: local
  gather_facts: false
  
  tasks:
    - name: "ğŸ” Tests de connectivitÃ©"
      include_tasks: tasks/connectivity-tests.yml
      
    - name: "ğŸŒ Tests de charge lÃ©gÃ¨re"
      include_tasks: tasks/load-tests.yml
      when: run_load_tests | default(false) | bool
      
    - name: "ğŸ“Š VÃ©rification des mÃ©triques"
      include_tasks: tasks/metrics-validation.yml

# Nettoyage et finalisation
- name: "ğŸ§¹ Nettoyage et finalisation"
  hosts: all
  become: true
  gather_facts: false
  
  tasks:
    - name: "ğŸ—‘ï¸ Nettoyage des artefacts temporaires"
      include_tasks: tasks/cleanup.yml
      
    - name: "ğŸ“§ Notification de fin de dÃ©ploiement"
      include_tasks: tasks/notify-completion.yml
      when: notifications_enabled | default(true) | bool

# Rapport final
- name: "ğŸ“Š GÃ©nÃ©ration du rapport de dÃ©ploiement"
  hosts: localhost
  connection: local
  gather_facts: false
  
  tasks:
    - name: "ğŸ“‹ GÃ©nÃ©ration du rapport"
      template:
        src: deployment-report.j2
        dest: "./reports/deployment-{{ deployment_id }}.yml"
        mode: '0644'
      vars:
        deployment_summary:
          id: "{{ deployment_id }}"
          timestamp: "{{ ansible_date_time.iso8601 }}"
          environment: "{{ target_environment | default('development') }}"
          strategy: "{{ deployment_strategy }}"
          version: "{{ app_version | default('latest') }}"
          duration: "{{ ansible_play_duration | default('N/A') }}"
          
    - name: "ğŸ‰ DÃ©ploiement terminÃ© avec succÃ¨s!"
      debug:
        msg:
          - "âœ… DÃ©ploiement {{ deployment_id }} terminÃ© avec succÃ¨s"
          - "ğŸŒ Application accessible via le load balancer"
          - "ğŸ“Š Rapport disponible: ./reports/deployment-{{ deployment_id }}.yml"
          - "ğŸ“ Logs dÃ©taillÃ©s: ./logs/ansible.log" 