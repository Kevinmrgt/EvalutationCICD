name: ðŸ”’ Security Checks (Safe Mode)

# Workflow de sÃ©curitÃ© simplifiÃ© qui Ã©vite les erreurs de permissions
# et fonctionne mÃªme sans toutes les fonctionnalitÃ©s GitHub Security activÃ©es

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

permissions:
  contents: read
  actions: read

env:
  NODE_VERSION: '18'

jobs:
  # ==========================================
  # Job 1: Basic Security Audit
  # ==========================================
  basic-security:
    name: ðŸ” Basic Security Audit
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“‚ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¥ Install dependencies
        run: npm ci

      - name: ðŸ” Run npm audit
        run: |
          echo "ðŸ” Running npm audit..."
          npm audit --audit-level moderate || echo "âš ï¸ Vulnerabilities found, but continuing..."
          npm audit --json > npm-audit.json || true

      - name: ðŸ” Check for common security patterns
        run: |
          echo "ðŸ” Checking for common security issues..."
          
          # Check for hardcoded secrets patterns
          echo "Checking for potential secrets..."
          grep -r -i "password\|secret\|token\|key" --include="*.js" --include="*.json" . --exclude-dir=node_modules || echo "No obvious secrets found"
          
          # Check for eval usage
          echo "Checking for eval usage..."
          grep -r "eval(" --include="*.js" . --exclude-dir=node_modules && echo "âš ï¸ eval() usage found" || echo "âœ… No eval() usage"
          
          # Check for console.log in production code
          echo "Checking for console.log..."
          find ./api -name "*.js" -exec grep -l "console\.log" {} \; || echo "âœ… No console.log found"

      - name: ðŸ“Š Upload npm audit results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: npm-audit-results
          path: npm-audit.json
          if-no-files-found: ignore

  # ==========================================
  # Job 2: Docker Security (No SARIF)
  # ==========================================
  docker-security-safe:
    name: ðŸ³ Docker Security (Safe)
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“‚ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ—ï¸ Build Docker image
        run: |
          echo "ðŸ³ Building Docker image for security scan..."
          docker build -t security-scan:test --target production .

      - name: ðŸ” Run Trivy scan (JSON output)
        run: |
          echo "ðŸ” Running Trivy vulnerability scanner..."
          docker run --rm -v /var/run/docker.sock:/var/run/docker.sock \
            -v "$(pwd):/tmp/results" \
            aquasec/trivy:latest image \
            --format json \
            --output /tmp/results/trivy-results.json \
            security-scan:test || echo "âš ï¸ Trivy scan completed with issues"

      - name: ðŸ“Š Upload Trivy results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: trivy-security-results
          path: trivy-results.json
          if-no-files-found: ignore

      - name: ðŸ” Basic image analysis
        run: |
          echo "ðŸ“Š Docker image analysis:"
          docker images security-scan:test
          
          echo "ðŸ” Checking image layers:"
          docker history security-scan:test --no-trunc || true
          
          echo "ðŸ” Checking for common security issues:"
          docker run --rm security-scan:test sh -c "ls -la /usr/src/app && whoami" || true

  # ==========================================
  # Job 3: Dependency Check
  # ==========================================
  dependency-check:
    name: ðŸ“¦ Dependency Security
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“‚ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¥ Install dependencies
        run: npm ci

      - name: ðŸ” Check package vulnerabilities
        run: |
          echo "ðŸ” Analyzing package.json..."
          
          # Check for outdated packages
          echo "ðŸ“Š Outdated packages:"
          npm outdated || echo "All packages up to date"
          
          # List all dependencies
          echo "ðŸ“‹ Dependencies audit:"
          npm list --depth=0
          
          # Check for security advisories
          echo "ðŸ”’ Security advisories:"
          npm audit --audit-level=moderate --parseable || echo "Security check completed"

      - name: ðŸ“Š Generate dependency report
        run: |
          echo "# ðŸ“¦ Dependency Security Report" > dependency-report.md
          echo "" >> dependency-report.md
          echo "## ðŸ“Š Package Analysis" >> dependency-report.md
          echo "" >> dependency-report.md
          echo "### Dependencies:" >> dependency-report.md
          npm list --depth=0 >> dependency-report.md
          echo "" >> dependency-report.md
          echo "Generated on: $(date)" >> dependency-report.md

      - name: ðŸ“Š Upload dependency report
        uses: actions/upload-artifact@v4
        with:
          name: dependency-security-report
          path: dependency-report.md

  # ==========================================
  # Job 4: Security Summary
  # ==========================================
  security-summary-safe:
    name: ðŸ“‹ Security Summary (Safe)
    runs-on: ubuntu-latest
    needs: [basic-security, docker-security-safe, dependency-check]
    if: always()

    steps:
      - name: ðŸ“¥ Download artifacts
        uses: actions/download-artifact@v4
        continue-on-error: true

      - name: ðŸ“‹ Generate security summary
        run: |
          echo "# ðŸ”’ Security Analysis Summary" > security-summary.md
          echo "" >> security-summary.md
          echo "## ðŸ“Š Job Results" >> security-summary.md
          echo "" >> security-summary.md
          echo "| Component | Status | Details |" >> security-summary.md
          echo "|-----------|--------|---------|" >> security-summary.md
          
          # Basic Security
          if [ "${{ needs.basic-security.result }}" == "success" ]; then
            echo "| Basic Security | âœ… PASS | npm audit and pattern checks completed |" >> security-summary.md
          else
            echo "| Basic Security | âš ï¸ ISSUES | Check npm audit results |" >> security-summary.md
          fi
          
          # Docker Security
          if [ "${{ needs.docker-security-safe.result }}" == "success" ]; then
            echo "| Docker Security | âœ… PASS | Image built and scanned successfully |" >> security-summary.md
          else
            echo "| Docker Security | âš ï¸ ISSUES | Check Trivy scan results |" >> security-summary.md
          fi
          
          # Dependencies
          if [ "${{ needs.dependency-check.result }}" == "success" ]; then
            echo "| Dependencies | âœ… PASS | Package analysis completed |" >> security-summary.md
          else
            echo "| Dependencies | âš ï¸ ISSUES | Check dependency report |" >> security-summary.md
          fi
          
          echo "" >> security-summary.md
          echo "## ðŸ“ Available Reports" >> security-summary.md
          echo "" >> security-summary.md
          echo "- npm-audit-results: NPM security audit" >> security-summary.md
          echo "- trivy-security-results: Container vulnerability scan" >> security-summary.md
          echo "- dependency-security-report: Package analysis" >> security-summary.md
          echo "" >> security-summary.md
          echo "Generated on: $(date)" >> security-summary.md

      - name: ðŸ“Š Upload security summary
        uses: actions/upload-artifact@v4
        with:
          name: security-analysis-summary
          path: security-summary.md

      - name: ðŸ“‹ Display summary
        run: |
          echo "ðŸ”’ Security Analysis Complete!"
          echo "=================="
          cat security-summary.md 