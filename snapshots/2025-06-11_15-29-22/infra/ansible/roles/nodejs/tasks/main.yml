---
# RÃ´le nodejs - Installation et configuration de Node.js et PM2
# Ce rÃ´le installe Node.js, npm, PM2 et configure l'environnement d'exÃ©cution

- name: 'ğŸ“‹ VÃ©rification des prÃ©requis Node.js'
  block:
    - name: 'ğŸ” VÃ©rification de la version Node.js existante'
      command: node --version
      register: current_node_version
      failed_when: false
      changed_when: false

    - name: 'ğŸ“Š Affichage de la version Node.js actuelle'
      debug:
        msg: "Version Node.js actuelle: {{ current_node_version.stdout | default('Non installÃ©') }}"

- name: "ğŸ“¦ Installation de Node.js {{ node_version | default('18') }}"
  block:
    - name: 'ğŸ”§ Ajout du repository NodeSource'
      shell: |
        curl -fsSL https://rpm.nodesource.com/setup_{{ node_version | default('18') }}.x | bash -
      args:
        creates: /etc/yum.repos.d/nodesource-el8.repo
      register: nodesource_repo
      retries: 3
      delay: 5

    - name: 'ğŸ“¦ Installation de Node.js via yum'
      yum:
        name: nodejs
        state: present
      register: nodejs_install
      retries: 3
      delay: 5
      until: nodejs_install is succeeded

    - name: "âœ… VÃ©rification de l'installation Node.js"
      command: '{{ item }}'
      register: node_check
      changed_when: false
      loop:
        - 'node --version'
        - 'npm --version'

    - name: 'ğŸ“Š Affichage des versions installÃ©es'
      debug:
        msg:
          - 'Node.js version: {{ node_check.results[0].stdout }}'
          - 'npm version: {{ node_check.results[1].stdout }}'

- name: 'ğŸ”§ Configuration npm'
  block:
    - name: 'âš™ï¸ Configuration npm globale'
      npm:
        name: '{{ item }}'
        global: yes
        state: present
      loop:
        - pm2
        - node-gyp
      register: npm_global_install
      retries: 3
      delay: 5
      until: npm_global_install is succeeded

    - name: 'ğŸ”§ Configuration du cache npm'
      shell: |
        npm config set cache {{ app_dir | default('/opt/nodejs-app') }}/.npm-cache
        npm config set tmp {{ app_dir | default('/opt/nodejs-app') }}/tmp
      become_user: "{{ app_user | default('nodejs') }}"
      become: yes

    - name: 'ğŸ“ CrÃ©ation du rÃ©pertoire cache npm'
      file:
        path: '{{ item }}'
        state: directory
        owner: "{{ app_user | default('nodejs') }}"
        group: "{{ app_user | default('nodejs') }}"
        mode: '0755'
      loop:
        - "{{ app_dir | default('/opt/nodejs-app') }}/.npm-cache"
        - "{{ app_dir | default('/opt/nodejs-app') }}/node_modules"

- name: 'ğŸš€ Configuration de PM2'
  block:
    - name: "âœ… VÃ©rification de l'installation PM2"
      command: pm2 --version
      register: pm2_version
      changed_when: false

    - name: 'ğŸ“Š Affichage de la version PM2'
      debug:
        msg: 'PM2 version: {{ pm2_version.stdout }}'

    - name: "ğŸ”§ Configuration PM2 pour l'utilisateur applicatif"
      become_user: "{{ app_user | default('nodejs') }}"
      become: yes
      block:
        - name: 'ğŸš€ Initialisation PM2'
          command: pm2 startup
          register: pm2_startup
          changed_when: false

        - name: 'ğŸ“ Configuration du fichier ecosystem PM2'
          template:
            src: ecosystem.config.js.j2
            dest: "{{ app_dir | default('/opt/nodejs-app') }}/ecosystem.config.js"
            mode: '0644'
            owner: "{{ app_user | default('nodejs') }}"
            group: "{{ app_user | default('nodejs') }}"

        - name: 'ğŸ“ CrÃ©ation des rÃ©pertoires PM2'
          file:
            path: '{{ item }}'
            state: directory
            owner: "{{ app_user | default('nodejs') }}"
            group: "{{ app_user | default('nodejs') }}"
            mode: '0755'
          loop:
            - "{{ app_dir | default('/opt/nodejs-app') }}/.pm2"
            - "{{ app_dir | default('/opt/nodejs-app') }}/.pm2/logs"
            - "{{ app_dir | default('/opt/nodejs-app') }}/.pm2/pids"

    - name: 'ğŸ”§ Configuration du service PM2 systÃ¨me'
      block:
        - name: 'ğŸ“ CrÃ©ation du service systemd pour PM2'
          template:
            src: pm2.service.j2
            dest: /etc/systemd/system/pm2-{{ app_user | default('nodejs') }}.service
            mode: '0644'
          notify: reload systemd

        - name: 'ğŸ”„ Rechargement de systemd'
          systemd:
            daemon_reload: yes

        - name: 'ğŸš€ Activation du service PM2'
          systemd:
            name: "pm2-{{ app_user | default('nodejs') }}"
            enabled: yes
            state: started

- name: "ğŸ”§ Configuration de l'environnement Node.js"
  block:
    - name: "ğŸ“ Configuration des variables d'environnement"
      template:
        src: nodejs.env.j2
        dest: "{{ app_dir | default('/opt/nodejs-app') }}/.env"
        mode: '0600'
        owner: "{{ app_user | default('nodejs') }}"
        group: "{{ app_user | default('nodejs') }}"
      vars:
        node_env: "{{ environment | default('development') }}"
        app_port: "{{ app_port | default('3000') }}"

    - name: "ğŸ”§ Configuration du profil bash pour l'utilisateur applicatif"
      template:
        src: bashrc.j2
        dest: "{{ app_dir | default('/opt/nodejs-app') }}/.bashrc"
        mode: '0644'
        owner: "{{ app_user | default('nodejs') }}"
        group: "{{ app_user | default('nodejs') }}"

    - name: 'ğŸ“‹ Configuration de logrotate pour PM2'
      template:
        src: pm2-logrotate.conf.j2
        dest: /etc/logrotate.d/pm2-{{ app_user | default('nodejs') }}
        mode: '0644'

- name: 'ğŸ› ï¸ Outils de dÃ©veloppement et utilitaires'
  block:
    - name: "ğŸ“¦ Installation d'outils npm globaux utiles"
      npm:
        name: '{{ item }}'
        global: yes
        state: present
      loop:
        - nodemon
        - forever
        - nvm
        - yarn
      when: install_dev_tools | default(true) | bool

    - name: 'ğŸ”§ Installation de packages systÃ¨me pour la compilation'
      yum:
        name:
          - gcc-c++
          - make
          - python3-devel
        state: present
      when: install_build_tools | default(true) | bool

- name: 'ğŸ¥ Tests de santÃ© et validation'
  block:
    - name: 'ğŸ§ª Test de fonctionnement de Node.js'
      shell: |
        echo "console.log('Node.js test:', process.version);" | node
      register: node_test
      changed_when: false

    - name: 'ğŸ§ª Test de fonctionnement de PM2'
      command: pm2 list
      become_user: "{{ app_user | default('nodejs') }}"
      become: yes
      register: pm2_test
      changed_when: false

    - name: 'ğŸ“Š Affichage des rÃ©sultats de test'
      debug:
        msg:
          - 'Node.js test result: {{ node_test.stdout }}'
          - "PM2 status: {{ 'OK' if pm2_test.rc == 0 else 'FAILED' }}"

- name: 'ğŸ“‹ Scripts utilitaires'
  block:
    - name: 'ğŸ“ CrÃ©ation des scripts de gestion Node.js'
      template:
        src: '{{ item.src }}'
        dest: '{{ item.dest }}'
        mode: '0755'
        owner: root
        group: root
      loop:
        - src: node-status.sh.j2
          dest: /usr/local/bin/node-status.sh
        - src: pm2-status.sh.j2
          dest: /usr/local/bin/pm2-status.sh
        - src: app-restart.sh.j2
          dest: /usr/local/bin/app-restart.sh
        - src: app-logs.sh.j2
          dest: /usr/local/bin/app-logs.sh

    - name: 'ğŸ”— CrÃ©ation de liens symboliques utiles'
      file:
        src: '{{ item.src }}'
        dest: '{{ item.dest }}'
        state: link
        force: yes
      loop:
        - src: /usr/bin/node
          dest: /usr/local/bin/node
        - src: /usr/bin/npm
          dest: /usr/local/bin/npm
        - src: /usr/bin/pm2
          dest: /usr/local/bin/pm2

- name: "âœ… Finalisation de l'installation Node.js"
  block:
    - name: 'ğŸ“Š Collecte des informations Node.js'
      set_fact:
        nodejs_info:
          node_version: '{{ node_check.results[0].stdout }}'
          npm_version: '{{ node_check.results[1].stdout }}'
          pm2_version: '{{ pm2_version.stdout }}'
          installation_date: '{{ ansible_date_time.iso8601 }}'
          app_user: "{{ app_user | default('nodejs') }}"
          app_dir: "{{ app_dir | default('/opt/nodejs-app') }}"

    - name: 'ğŸ“ Sauvegarde des informations Node.js'
      copy:
        content: '{{ nodejs_info | to_nice_yaml }}'
        dest: "{{ app_dir | default('/opt/nodejs-app') }}/nodejs-info.yml"
        mode: '0644'
        owner: "{{ app_user | default('nodejs') }}"
        group: "{{ app_user | default('nodejs') }}"

    - name: 'ğŸ‰ Installation Node.js terminÃ©e'
      debug:
        msg:
          - 'âœ… Node.js {{ node_check.results[0].stdout }} installÃ© avec succÃ¨s'
          - 'âœ… PM2 {{ pm2_version.stdout }} configurÃ©'
          - "ğŸ“ Application directory: {{ app_dir | default('/opt/nodejs-app') }}"
          - "ğŸ‘¤ Application user: {{ app_user | default('nodejs') }}"
          - "ğŸ”§ Service PM2: pm2-{{ app_user | default('nodejs') }}"
